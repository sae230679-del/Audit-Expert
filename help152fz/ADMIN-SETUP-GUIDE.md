# help152fz.ru — Руководство по настройке через админку

**Этот файл описывает пошаговую настройку всех сервисов для help152fz.ru**
**Все настройки копируются с securelex.ru и адаптируются для нового домена**

---

## 1. ЮКАССА (Платежи)

### Шаг 1: Создать магазин в ЮКасса
1. Войти в https://yookassa.ru/my/shops
2. Нажать "Добавить магазин"
3. Указать:
   - Название: help152fz.ru
   - Сайт: https://help152fz.ru
   - Описание: Сервис аудита сайтов на соответствие ФЗ-152
4. Пройти модерацию (обычно 1-3 рабочих дня)

### Шаг 2: Получить ключи
1. В личном кабинете ЮКасса → Настройки → API ключи
2. Скопировать:
   - **Shop ID** (числовой идентификатор)
   - **Секретный ключ** (начинается с `live_` или `test_`)

### Шаг 3: Настроить Webhook в ЮКасса
1. В личном кабинете ЮКасса → Настройки → HTTP-уведомления
2. URL для уведомлений: `https://help152fz.ru/api/payments/webhook`
3. Выбрать события:
   - payment.succeeded
   - payment.canceled
   - payment.waiting_for_capture
   - refund.succeeded

### Шаг 4: Настроить в админке help152fz.ru
1. Войти как SuperAdmin (sae230679@yandex.ru)
2. Перейти: SuperAdmin → Настройки → Платежи
3. Заполнить:
   - **ЮКасса включена**: Да
   - **Shop ID**: ваш_shop_id
   - **Секретный ключ**: ваш_secret_key
4. Сохранить

### Шаг 5: Тестирование
1. Открыть любой платный инструмент
2. Нажать "Оплатить"
3. Должна открыться страница ЮКасса
4. Проверить что return_url ведёт на https://help152fz.ru/payment-result (формируется автоматически)
5. Проверить webhook — при успешной оплате статус должен обновиться

**ВАЖНО**: В коде returnUrl формируется автоматически из DOMAIN переменной. Убедитесь что DOMAIN=https://help152fz.ru в .env!

В чеке (receipt) email по умолчанию info@securelex.ru — после настройки почты изменить в коде на info@help152fz.ru (файл server/yookassa.ts, строка ~126).

---

## 2. ПОЧТОВЫЕ УВЕДОМЛЕНИЯ (SMTP)

### Шаг 1: Создать почтовый ящик
**Вариант А: Через Hestia Panel (рекомендуется)**
1. Войти в https://77.222.37.120:8083 (admin / Que8shee2aa1oz)
2. Mail → Add Mail Domain → help152fz.ru
3. Создать ящик: support@help152fz.ru

**Вариант Б: Через REG.RU (если домен там)**
1. reg.ru → Хостинг → Почта
2. Создать ящик support@help152fz.ru

**Вариант В: Через Яндекс.Почту для домена**
1. connect.yandex.ru → Добавить домен
2. Создать ящик support@help152fz.ru

### Шаг 2: Настроить SMTP в админке
1. SuperAdmin → Настройки → Почта
2. Заполнить:
   - **SMTP включён**: Да
   - **SMTP хост**: зависит от провайдера (см. ниже)
   - **SMTP порт**: 465 (SSL) или 587 (STARTTLS)
   - **SSL**: Да (для порта 465)
   - **Пользователь**: support@help152fz.ru
   - **Пароль**: пароль от почтового ящика
   - **Email отправителя**: support@help152fz.ru
   - **Имя отправителя**: help152fz.ru
   - **Reply-To**: support@help152fz.ru

### Настройки SMTP по провайдерам

| Провайдер | Хост | Порт | SSL |
|-----------|------|------|-----|
| Hestia (локальный) | localhost | 465 | Да |
| REG.RU | sm30.hosting.reg.ru | 465 | Да |
| Яндекс.Почта | smtp.yandex.ru | 465 | Да |
| Mail.ru | smtp.mail.ru | 465 | Да |

### Шаг 3: Отправить тестовое письмо
1. SuperAdmin → Настройки → Почта → Тестовое письмо
2. Указать свой email
3. Нажать "Отправить"
4. Проверить входящие (и папку Спам!)

### Какие уведомления отправляются автоматически:
- Подтверждение регистрации (с ссылкой верификации)
- Восстановление пароля (с ссылкой сброса)
- Аудит завершён (результаты экспресс/полного аудита)
- Подтверждение оплаты (чек)
- Реферальные начисления (уведомление о заработке)
- Новый реферал зарегистрирован
- Статус договора изменён
- Контактная форма (уведомление менеджеру)

---

## 3. OAUTH (Яндекс ID + ВК ID)

### 3A. Яндекс ID

#### Шаг 1: Зарегистрировать приложение
1. Перейти: https://oauth.yandex.ru/client/new
2. Заполнить:
   - **Название**: help152fz.ru
   - **Описание**: Авторизация на сайте help152fz.ru
   - **Платформа**: Веб-сервисы
   - **Redirect URI**: `https://help152fz.ru/api/oauth/yandex/callback`
3. Права:
   - login:email
   - login:info
4. Сохранить
5. Скопировать **Client ID** и **Client Secret**

#### Шаг 2: Настроить в админке
1. SuperAdmin → Настройки → OAuth
2. Яндекс:
   - **Включён**: Да
   - **Client ID**: ваш_client_id
   - **Client Secret**: ваш_client_secret
3. Сохранить

### 3B. ВК ID

#### Шаг 1: Зарегистрировать приложение
1. Перейти: https://id.vk.com/about/business/go/
2. Создать приложение:
   - **Название**: help152fz.ru
   - **Платформа**: Сайт
   - **Адрес сайта**: https://help152fz.ru
   - **Redirect URI**: `https://help152fz.ru/api/oauth/vk/callback`
3. Получить **App ID** и **Secure Key**

#### Шаг 2: Настроить в админке
1. SuperAdmin → Настройки → OAuth
2. ВК:
   - **Включён**: Да
   - **Client ID**: ваш_app_id
   - **Client Secret**: ваш_secure_key
3. Сохранить

### Проверка OAuth
1. Выйти из аккаунта
2. На странице входа нажать "Войти через Яндекс"
3. Проверить что redirect_uri ведёт на help152fz.ru (не securelex.ru!)
4. После авторизации должен создаться аккаунт и выполниться вход
5. Повторить для ВК ID

**ВАЖНО**: Callback URL формируется автоматически из заголовка Host запроса (функция getBaseUrl в oauth.ts). Но fallback — securelex.ru! Убедитесь что DOMAIN=https://help152fz.ru в .env.

---

## 4. РЕФЕРАЛЬНАЯ ПРОГРАММА

### Архитектура (скопировано с securelex.ru)

Реферальная программа поддерживает 3 типа участников:
- **Самозанятые** (self_employed) — ИНН, ФИО, телефон
- **ИП** (ip) — ИНН, ОГРНИП, ФИО, телефон, банковские реквизиты
- **ООО** (ooo) — ИНН, КПП, ОГРН, название компании, юр. адрес, банковские реквизиты

### Процесс работы:
1. Пользователь регистрируется в реферальной программе, выбирая тип (самозанятый/ИП/ООО)
2. Заполняет данные (ИНН, банковские реквизиты и т.д.)
3. Заявка уходит на проверку администратору
4. Админ одобряет или отклоняет заявку
5. После одобрения пользователь получает реферальную ссылку
6. Каждый платящий клиент по ссылке приносит процент от оплаты
7. При накоплении минимальной суммы — запрос на выплату
8. Выплата через ЮКасса или ручной перевод

### Настройка в админке
1. SuperAdmin → Реферальная программа → Настройки
2. Скопировать с securelex.ru:
   - **Программа включена**: Да
   - **Процент вознаграждения**: (как на securelex.ru, обычно 10-20%)
   - **Фиксированное вознаграждение**: (если есть)
   - **Бонус за регистрацию**: (если есть)
   - **Минимальная сумма выплаты**: (обычно 1000-5000 руб)
   - **Текст оферты**: (скопировать из securelex.ru)
3. Сохранить

### Управление участниками
1. SuperAdmin → Реферальная программа → Участники
2. Для каждой заявки:
   - Проверить ИНН (через DaData автоматически)
   - Проверить банковские реквизиты
   - Одобрить или отклонить
   - Указать причину отказа (если отклонено)

### Связка с ЮКасса
- Выплаты привязаны к ЮКасса (если настроена)
- Для выплат на карту используется API ЮКасса (payouts)
- Альтернативно — ручной перевод с отметкой в системе

### Пользовательские ссылки
- Каждый участник может создавать кастомные реферальные ссылки
- Отслеживание кликов и конверсий по каждой ссылке
- Статистика в личном кабинете участника

---

## 5. DADATA (Автодополнение ИНН)

### Шаг 1: Получить API-ключи
1. Зарегистрироваться: https://dadata.ru
2. Личный кабинет → API-ключи
3. Скопировать:
   - **API-ключ** (Token)
   - **Секретный ключ** (Secret)

### Шаг 2: Настроить в админке
1. SuperAdmin → Настройки → Интеграции
2. DaData:
   - **API-ключ**: ваш_токен
   - **Secret**: ваш_секрет
3. Сохранить

### Где используется DaData:
- **Панель менеджера**: автодополнение компании по ИНН
- **Панель юриста**: поиск и проверка данных организации
- **Реферальная программа**: валидация ИНН участников
- **CRM-152**: автозаполнение данных оператора ПДн

---

## 6. ПАНЕЛЬ МЕНЕДЖЕРА И ЮРИСТА

### Панель менеджера
- Доступ к аудитам клиентов
- Управление заявками
- Просмотр компаний с автодополнением по ИНН (DaData)
- Отчёты по платежам

### Панель юриста
- Работа с юридическими документами
- Проверка данных организаций по ИНН
- Подготовка документов для операторов ПДн
- Консультации по ФЗ-152

### Создание пользователей с нужными ролями
1. SuperAdmin → Пользователи
2. Изменить роль пользователя:
   - `manager` — менеджер
   - `lawyer` — юрист
3. Или пригласить по email с указанием роли

---

## 7. TELEGRAM БОТ (опционально)

### Создание бота
1. В Telegram написать @BotFather
2. /newbot → Имя: Help152FZ Bot → Username: help152fz_support_bot
3. Скопировать токен
4. Указать в .env: TELEGRAM_BOT_TOKEN=ваш_токен

### Настройка Chat ID
1. Добавить бота в группу для уведомлений
2. Отправить сообщение в группу
3. Получить Chat ID через API: `https://api.telegram.org/botТОКЕН/getUpdates`
4. Указать в .env: TELEGRAM_CHAT_ID=ваш_chat_id

---

## 8. ВАЖНЫЕ ЗАМЕЧАНИЯ О КОДЕ

### Fallback-значения securelex.ru
В коде есть fallback-значения (по умолчанию), которые ссылаются на securelex.ru:
- `server/email.ts` (строки 111-112): smtp_user и smtp_from по умолчанию "support@securelex.ru"
- `server/yookassa.ts` (строки 126, 206): email в чеке "info@securelex.ru"
- `server/pdf-html-generator.ts` (строка 19): email "info@securelex.ru"
- `server/routes.ts`: отправка уведомлений на "support@securelex.ru"

**Это НЕ проблема**, если настроить через админку:
- SMTP настройки (хост, порт, user, from) — перезаписывают fallback из email.ts
- ЮКасса email — используется email клиента, если он есть. Fallback только если нет email

**При желании** можно поменять fallback в коде (заменить securelex.ru на help152fz.ru), но это необязательно если все настроено через админку.

### Переменная DOMAIN
Самая важная настройка — `DOMAIN=https://help152fz.ru` в .env и ecosystem.config.cjs.
Она влияет на:
- OAuth callback URLs (автоматически через getBaseUrl)
- Ссылки в email-письмах (через SITE_URL)
- Return URL для платежей ЮКасса
- Ссылки в Telegram уведомлениях

---

## КОДОВАЯ ФРАЗА ДЛЯ АГЕНТА

При работе с проектом help152fz.ru скажите агенту:

**"Настрой help152fz"**

Агент должен:
1. Прочитать файл `help152fz/SESSION_CONTEXT-help152fz.md`
2. Прочитать файл `help152fz/DEPLOY-help152fz.md`
3. Прочитать файл `help152fz/ADMIN-SETUP-GUIDE.md`
4. Подключиться к VPS 77.222.37.120
5. Выполнить необходимые настройки/исправления
