# Техническое Задание: Платформа аудита соответствия 152-ФЗ

## 1. Общее описание проекта

### 1.1 Назначение
Веб-платформа для проверки сайтов на соответствие российскому законодательству о защите персональных данных (Федеральный закон 152-ФЗ "О персональных данных" и 149-ФЗ "Об информации").

### 1.2 Целевая аудитория
- Владельцы сайтов
- Веб-разработчики и агентства
- Юридические отделы компаний
- ИП и самозанятые с онлайн-присутствием

### 1.3 Ключевые возможности
- Бесплатная экспресс-проверка сайта за 30 секунд
- Платный детальный отчет с рекомендациями
- Пакеты услуг для разных типов сайтов
- Личный кабинет пользователя
- Реферальная программа
- Админ-панель с разграничением ролей

---

## 2. Технический стек

### 2.1 Frontend
| Технология | Назначение |
|------------|------------|
| React 18 + TypeScript | UI-фреймворк |
| Vite | Сборщик и dev-сервер |
| Wouter | Маршрутизация |
| TanStack React Query | Управление серверным состоянием |
| React Hook Form + Zod | Формы и валидация |
| Tailwind CSS | Стилизация |
| shadcn/ui (Radix UI) | UI-компоненты |
| Lucide React | Иконки |

### 2.2 Backend
| Технология | Назначение |
|------------|------------|
| Node.js + Express | Web-сервер |
| TypeScript + ESM | Язык и модули |
| Drizzle ORM | Работа с БД |
| JWT | Аутентификация |
| bcryptjs | Хеширование паролей |

### 2.3 База данных
- PostgreSQL (Neon-backed)

### 2.4 Внешние интеграции
- YooKassa — платежи
- VK OAuth — авторизация через ВКонтакте
- Yandex OAuth — авторизация через Яндекс

---

## 3. Структура базы данных

### 3.1 Таблица `users` — Пользователи
| Поле | Тип | Описание |
|------|-----|----------|
| id | varchar (UUID) | Первичный ключ |
| username | text | Логин (уникальный) |
| password | text | Хешированный пароль |
| email | text | Email |
| role | text | Роль: user / admin / superadmin |
| referralCode | text | Уникальный реферальный код |
| referredBy | varchar | ID пригласившего пользователя |
| bonusBalance | integer | Бонусный баланс (рубли) |
| fullName | text | ФИО |
| phone | text | Телефон |
| whatsapp | text | WhatsApp |
| telegramHandle | text | Telegram |
| vkProfile | text | Профиль VK |
| organizationInn | text | ИНН организации |
| siteUrl | text | URL сайта |
| vkId | text | ID ВКонтакте (OAuth) |
| yandexId | text | ID Яндекса (OAuth) |
| avatarUrl | text | URL аватара |
| createdAt | timestamp | Дата регистрации |

### 3.2 Таблица `packages` — Пакеты услуг
| Поле | Тип | Описание |
|------|-----|----------|
| id | varchar (UUID) | Первичный ключ |
| name | text | Название пакета |
| description | text | Описание |
| price | integer | Цена (рубли) |
| features | text[] | Список возможностей |
| criteria | text[] | Критерии проверки |
| deadline | text | Срок выполнения |
| icon | text | Иконка |
| sortOrder | integer | Порядок сортировки |
| isActive | boolean | Активность |

### 3.3 Таблица `orders` — Заказы
| Поле | Тип | Описание |
|------|-----|----------|
| id | varchar (UUID) | Первичный ключ |
| userId | varchar | ID пользователя |
| siteUrl | text | URL проверяемого сайта |
| email | text | Email заказчика |
| siteType | text | Тип сайта |
| packageId | varchar | ID пакета |
| promoCodeId | varchar | ID промокода |
| orderType | text | Тип: express / package |
| status | text | Статус: pending / paid / completed |
| totalScore | integer | Итоговый балл |
| auditResults | jsonb | Результаты аудита |
| paymentId | text | ID платежа YooKassa |
| paymentStatus | text | Статус платежа |
| amount | integer | Сумма (рубли) |
| discountAmount | integer | Сумма скидки |
| createdAt | timestamp | Дата создания |
| paidAt | timestamp | Дата оплаты |
| completedAt | timestamp | Дата завершения |

### 3.4 Таблица `promoCodes` — Промокоды
| Поле | Тип | Описание |
|------|-----|----------|
| id | varchar (UUID) | Первичный ключ |
| code | text | Код (уникальный) |
| description | text | Описание |
| discountType | text | Тип: percent / fixed |
| discountValue | integer | Значение скидки |
| maxUses | integer | Макс. использований (null = безлимит) |
| currentUses | integer | Текущее кол-во использований |
| expiresAt | timestamp | Срок действия |
| minOrderAmount | integer | Мин. сумма заказа |
| isActive | boolean | Активность |
| createdAt | timestamp | Дата создания |

### 3.5 Таблица `referralSettings` — Настройки реферальной программы
| Поле | Тип | Описание |
|------|-----|----------|
| id | varchar (UUID) | Первичный ключ |
| referrerBonus | integer | Бонус рефереру (рубли) |
| refereeDiscount | integer | Скидка приглашенному (%) |
| commissionPercent | integer | Комиссия от заказов (%) |
| minPayoutAmount | integer | Мин. сумма вывода (рубли) |
| isActive | boolean | Активность |

### 3.6 Таблица `referrals` — Рефералы
| Поле | Тип | Описание |
|------|-----|----------|
| id | varchar (UUID) | Первичный ключ |
| referrerId | varchar | ID пригласившего |
| refereeId | varchar | ID приглашенного |
| status | text | registered / ordered / paid |
| commissionEarned | integer | Заработанная комиссия |
| createdAt | timestamp | Дата |

### 3.7 Таблица `payouts` — Заявки на выплату
| Поле | Тип | Описание |
|------|-----|----------|
| id | varchar (UUID) | Первичный ключ |
| userId | varchar | ID пользователя |
| amount | integer | Сумма (рубли) |
| status | text | pending / processing / completed / rejected |
| paymentMethod | text | Способ: card / yoomoney / qiwi |
| paymentDetails | text | Реквизиты |
| adminComment | text | Комментарий админа |
| createdAt | timestamp | Дата создания |
| processedAt | timestamp | Дата обработки |

### 3.8 Таблица `faqItems` — FAQ
| Поле | Тип | Описание |
|------|-----|----------|
| id | varchar (UUID) | Первичный ключ |
| question | text | Вопрос |
| answer | text | Ответ |
| sortOrder | integer | Порядок |
| isActive | boolean | Активность |

### 3.9 Таблица `cases` — Кейсы
| Поле | Тип | Описание |
|------|-----|----------|
| id | varchar (UUID) | Первичный ключ |
| title | text | Заголовок |
| siteType | text | Тип сайта |
| description | text | Описание |
| beforeScore | integer | Балл до |
| afterScore | integer | Балл после |
| issues | text[] | Выявленные проблемы |
| solutions | text[] | Решения |
| testimonial | text | Отзыв клиента |
| clientName | text | Имя клиента |
| sortOrder | integer | Порядок |
| isActive | boolean | Активность |

### 3.10 Таблица `contactMessages` — Сообщения формы
| Поле | Тип | Описание |
|------|-----|----------|
| id | varchar (UUID) | Первичный ключ |
| name | text | Имя |
| email | text | Email |
| phone | text | Телефон |
| message | text | Сообщение |
| isRead | boolean | Прочитано |
| isSpam | boolean | Спам |
| createdAt | timestamp | Дата |

### 3.11 Таблица `siteSettings` — Настройки сайта
| Поле | Тип | Описание |
|------|-----|----------|
| id | varchar (UUID) | Первичный ключ |
| companyName | text | Название компании |
| companyType | text | ИП / ООО / Самозанятый |
| inn | text | ИНН |
| ogrn | text | ОГРН |
| address | text | Адрес |
| phone | text | Телефон |
| email | text | Email |
| privacyEmail | text | Email для запросов по ПДн |
| telegram | text | Telegram |
| vk | text | VK |
| bankName | text | Название банка |
| bankAccount | text | Расчетный счет |
| bik | text | БИК |
| correspondentAccount | text | Корр. счет |
| privacyPolicy | text | Политика конфиденциальности |
| termsOfService | text | Пользовательское соглашение |
| cookiePolicy | text | Политика cookies |
| consentText | text | Текст согласия |
| offerText | text | Текст оферты |
| yookassaShopId | text | ID магазина YooKassa |
| yookassaSecretKey | text | Секретный ключ YooKassa |
| yookassaTestMode | boolean | Тестовый режим платежей |
| expressReportPrice | integer | Цена экспресс-отчета |
| casesPageEnabled | boolean | Показывать кейсы |
| vkAppId | text | VK App ID |
| vkAppSecret | text | VK App Secret |
| yandexClientId | text | Yandex Client ID |
| yandexClientSecret | text | Yandex Client Secret |
| oauthEnabled | boolean | OAuth включен |

### 3.12 Дополнительные таблицы
- `notifications` — уведомления пользователей
- `userSubscriptions` — настройки подписок
- `commissions` — история начислений комиссий
- `menuItems` — пункты меню

---

## 4. Критерии проверки сайтов (9 критериев)

| # | Критерий | Описание | Статусы |
|---|----------|----------|---------|
| 1 | HTTPS/SSL сертификат | Наличие защищенного соединения | pass / fail |
| 2 | Политика конфиденциальности | Наличие и корректность политики | pass / warning / fail |
| 3 | Согласие на обработку ПДн | Чекбоксы согласия в формах | pass / fail |
| 4 | Cookie-баннер | Уведомление о cookies | pass / warning |
| 5 | Иностранные ресурсы | Подключение скриптов с иностранных серверов | pass / fail |
| 6 | Формы сбора данных | Корректность форм сбора ПДн | pass / warning |
| 7 | Контактная информация | Наличие контактов оператора | pass / warning |
| 8 | Авторизация | Безопасность систем авторизации | pass / fail |
| 9 | Реестр Роскомнадзора | Регистрация оператора ПДн | pass / fail |

### Расчет итогового балла
- Pass = 100 баллов / 9 критериев = 11.1 балла
- Warning = 50% от pass = 5.5 балла
- Fail = 0 баллов

### Итоговые статусы
- **good** (70-100 баллов) — сайт соответствует требованиям
- **average** (40-69 баллов) — требуется доработка
- **critical** (0-39 баллов) — критические нарушения

---

## 5. Страницы сайта

### 5.1 Публичные страницы

#### Главная страница `/`
- Hero-секция с формой бесплатной проверки
- Блок "Как это работает" (3 шага)
- Секция пакетов услуг
- Блок кейсов (примеры аудитов)
- FAQ (аккордеон)
- Форма обратной связи
- Футер с контактами и документами

#### Страница авторизации `/auth`
- Вкладки: Вход / Регистрация
- Форма входа: логин + пароль
- Форма регистрации: имя, email, пароль, реф. код
- Кнопки OAuth: VK, Яндекс
- Ссылка на восстановление пароля

#### Страница callback OAuth `/auth-callback`
- Обработка редиректа после OAuth
- Автоматический вход / регистрация

#### Страница оплаты `/payment`
- Выбор типа заказа (экспресс / пакет)
- Форма: ФИО, email, телефон, компания
- Поле промокода с валидацией
- Чекбоксы согласий (152-ФЗ)
- Кнопка оплаты

#### Страницы документов `/privacy`, `/terms`, `/cookies`, `/consent`
- Политика конфиденциальности
- Пользовательское соглашение
- Политика cookies
- Согласие на обработку ПДн

#### Страница кейсов `/cases`
- Список успешных кейсов аудита
- Фильтрация по типу сайта

### 5.2 Личный кабинет `/cabinet`

#### Вкладки:
1. **Мои заказы** — история заказов с фильтрами
2. **Профиль** — редактирование данных пользователя
3. **Рефералы** — реферальная ссылка, статистика, баланс
4. **Выплаты** — запрос выплаты, история
5. **Уведомления** — список уведомлений
6. **Подписки** — настройки email-рассылок

---

## 6. Админ-панель `/admin`

### 6.1 Роли доступа

| Функция | admin | superadmin |
|---------|-------|------------|
| Панель управления | + | + |
| Пользователи | - | + |
| Пакеты услуг | + | + |
| Промокоды | - | + |
| Рефералы | - | + |
| Кейсы | + | + |
| FAQ | + | + |
| Сообщения | + | + |
| Настройки сайта | - | + |
| Документы | + | + |
| Платежи | - | + |

### 6.2 Разделы админ-панели

#### Панель управления `/admin`
- Статистика: заказы, пользователи, выручка
- Графики и диаграммы
- Последние заказы и сообщения

#### Пользователи `/admin/users`
- Таблица пользователей
- Фильтры по роли
- Изменение роли (только superadmin)
- Удаление пользователей

#### Пакеты услуг `/admin/packages`
- CRUD пакетов услуг
- Drag & drop сортировка
- Активация/деактивация

#### Промокоды `/admin/promo-codes`
- Создание промокодов
- Типы: процент / фиксированная сумма
- Лимиты использования
- Срок действия
- Мин. сумма заказа

#### Реферальная программа `/admin/referrals`
- Настройки: % комиссии, мин. вывод, бонусы
- Заявки на выплату (одобрить/отклонить)
- Список участников программы
- Статистика

#### Кейсы `/admin/cases`
- CRUD кейсов
- Поля: название, тип, описание, баллы до/после
- Проблемы и решения (массивы)
- Отзыв клиента

#### FAQ `/admin/faq`
- CRUD вопросов/ответов
- Сортировка
- Активация/деактивация

#### Сообщения `/admin/messages`
- Входящие сообщения формы
- Пометка прочитано/спам
- Удаление

#### Настройки сайта `/admin/settings`
Вкладки:
1. **Компания** — реквизиты (тип, название, ИНН, ОГРН, адрес)
2. **Контакты** — телефон, email, Telegram, VK
3. **Банк** — название, счет, БИК, корр. счет
4. **YooKassa** — Shop ID, секретный ключ, тестовый режим
5. **Цены** — цена экспресс-отчета
6. **Страницы** — вкл/выкл страницы кейсов
7. **OAuth** — VK и Яндекс App ID/Secret

#### Документы `/admin/documents`
- Редактор юридических документов
- Политика конфиденциальности
- Пользовательское соглашение
- Политика cookies
- Текст согласия
- Оферта

#### Платежи `/admin/payments`
- Список всех заказов
- Фильтры по статусу
- Детали платежей

---

## 7. Система авторизации

### 7.1 Email + пароль
- Регистрация: username, email, password
- Вход: username + password
- JWT токен (срок: 24 часа)
- Хеширование: bcrypt (10 rounds)

### 7.2 OAuth VK
- Endpoint инициации: `/api/auth/vk`
- Callback: `/api/auth/vk/callback`
- Автосоздание пользователя
- Привязка к существующему по email

### 7.3 OAuth Яндекс
- Endpoint инициации: `/api/auth/yandex`
- Callback: `/api/auth/yandex/callback`
- Автосоздание пользователя
- Привязка к существующему по email

### 7.4 Генерация username для OAuth
- VK: `vk_{vk_id}`
- Яндекс: `yandex_{yandex_id}`
- Случайный пароль: 16 символов

---

## 8. Реферальная программа

### 8.1 Механика
1. Каждый пользователь получает уникальный реферальный код
2. Формат кода: 8 символов (A-Z, 0-9)
3. Ссылка: `https://your-domain.ru/?ref=XXXXXXXX`
4. При регистрации по ссылке — привязка к рефереру

### 8.2 Начисления
- **Комиссия** — % от каждого заказа приглашенного (по умолчанию 20%)
- **Бонус рефереру** — фиксированная сумма за регистрацию (по умолчанию 100₽)
- **Скидка приглашенному** — % на первый заказ (по умолчанию 10%)

### 8.3 Выплаты
- Минимальная сумма: 500₽ (настраивается)
- Способы: банковская карта, ЮMoney, QIWI
- Статусы: pending → processing → completed/rejected

---

## 9. Система промокодов

### 9.1 Типы скидок
- **percent** — процент от суммы (1-100%)
- **fixed** — фиксированная сумма в рублях

### 9.2 Ограничения
- Максимальное количество использований
- Срок действия
- Минимальная сумма заказа

### 9.3 Валидация (серверная)
- Проверка активности
- Проверка срока
- Проверка лимита использований
- Проверка минимальной суммы
- Rate limiting: 10 запросов / минута

---

## 10. Интеграция YooKassa

### 10.1 Настройки
- Shop ID (идентификатор магазина)
- Secret Key (секретный ключ)
- Тестовый режим (вкл/выкл)

### 10.2 Процесс оплаты
1. Клиент заполняет форму
2. Сервер создает заказ
3. Применяется промокод (если есть)
4. Создается платеж в YooKassa
5. Редирект на страницу оплаты
6. Webhook подтверждает оплату
7. Заказ переходит в статус "paid"

### 10.3 Тестовый режим
- Платеж сразу помечается как успешный
- Не требует настройки YooKassa

---

## 11. Формы и валидация

### 11.1 Форма аудита
| Поле | Валидация |
|------|-----------|
| siteUrl | URL формат, обязательно |
| email | Email формат, обязательно |
| siteType | Обязательно (select) |
| agreePrivacy | Чекбокс, обязательно true |
| consent | Чекбокс, обязательно true |

### 11.2 Форма регистрации
| Поле | Валидация |
|------|-----------|
| username | Минимум 3 символа |
| email | Email формат |
| password | Минимум 6 символов |
| referralCode | Опционально |

### 11.3 Форма обратной связи
| Поле | Валидация |
|------|-----------|
| name | Обязательно |
| email | Email формат, обязательно |
| phone | Опционально |
| message | Обязательно |
| honeypot | Скрытое поле (защита от спама) |
| captcha | Математическая задача |

### 11.4 Защита форм
- Honeypot field (скрытое поле)
- Математическая капча
- Rate limiting: 3 запроса / минута
- Серверная валидация через Zod

---

## 12. API Endpoints

### 12.1 Публичные

| Метод | Endpoint | Описание |
|-------|----------|----------|
| GET | /api/packages | Список активных пакетов |
| GET | /api/packages/:id | Детали пакета |
| GET | /api/faq | Список FAQ |
| GET | /api/cases | Список кейсов |
| GET | /api/settings/public | Публичные настройки |
| POST | /api/contact | Отправка сообщения |
| POST | /api/audit/check | Запуск проверки |
| POST | /api/payment/create | Создание платежа |
| POST | /api/promo/validate | Валидация промокода |

### 12.2 Авторизация

| Метод | Endpoint | Описание |
|-------|----------|----------|
| POST | /api/auth/login | Вход (admin) |
| POST | /api/auth/register | Регистрация |
| POST | /api/auth/user/login | Вход (user) |
| GET | /api/auth/vk | Инициация VK OAuth |
| GET | /api/auth/vk/callback | Callback VK |
| GET | /api/auth/yandex | Инициация Яндекс OAuth |
| GET | /api/auth/yandex/callback | Callback Яндекс |

### 12.3 Личный кабинет (требует авторизации)

| Метод | Endpoint | Описание |
|-------|----------|----------|
| GET | /api/user/profile | Профиль пользователя |
| PATCH | /api/user/profile | Обновление профиля |
| GET | /api/user/orders | Заказы пользователя |
| GET | /api/user/referrals | Рефералы пользователя |
| POST | /api/user/payouts | Запрос выплаты |
| GET | /api/user/payouts | История выплат |
| GET | /api/user/notifications | Уведомления |
| PATCH | /api/user/notifications/:id | Прочитать уведомление |

### 12.4 Админ-панель (требует роли admin/superadmin)

| Метод | Endpoint | Роль | Описание |
|-------|----------|------|----------|
| GET | /api/admin/stats | admin | Статистика |
| GET/POST/PATCH/DELETE | /api/admin/users | superadmin | CRUD пользователей |
| GET/POST/PATCH/DELETE | /api/admin/packages | admin | CRUD пакетов |
| GET/POST/PATCH/DELETE | /api/admin/faq | admin | CRUD FAQ |
| GET/POST/PATCH/DELETE | /api/admin/cases | admin | CRUD кейсов |
| GET/PATCH/DELETE | /api/admin/messages | admin | Сообщения |
| GET/PUT | /api/admin/settings | superadmin | Настройки |
| GET | /api/admin/orders | admin | Заказы |
| GET/POST/PATCH/DELETE | /api/admin/promo-codes | superadmin | Промокоды |
| GET/PATCH | /api/admin/referral-settings | superadmin | Настройки рефералов |
| GET/PATCH | /api/admin/payouts | superadmin | Заявки на выплату |

---

## 13. Дизайн и UX

### 13.1 Цветовая схема
- Основной цвет (primary): синий (#2563eb)
- Фон: светлый (#fafafa) / темный (#0a0a0a)
- Карточки: белый (#ffffff) / темно-серый (#1a1a1a)
- Акцент: голубой (#06b6d4)
- Успех: зеленый (#22c55e)
- Ошибка: красный (#ef4444)
- Предупреждение: желтый (#eab308)

### 13.2 Темная тема
- Переключатель в header
- Сохранение в localStorage
- CSS-переменные для всех цветов
- Класс `.dark` на `<html>`

### 13.3 Типографика
- Основной шрифт: Inter
- Заголовки: DM Sans
- Код: Geist Mono

### 13.4 Адаптивность
- Mobile-first подход
- Breakpoints: sm (640px), md (768px), lg (1024px), xl (1280px)
- Мобильное меню (hamburger)
- Адаптивные таблицы

### 13.5 Компоненты
- Button (варианты: default, secondary, outline, ghost, destructive)
- Card (с header, content, footer)
- Dialog / Sheet (модальные окна)
- Tabs / Accordion
- Form inputs с валидацией
- Toast уведомления
- Skeleton загрузки

---

## 14. Безопасность

### 14.1 Аутентификация
- JWT токены с подписью
- Хеширование паролей (bcrypt)
- Срок действия токена: 24 часа
- Проверка роли на каждом защищенном endpoint

### 14.2 Защита форм
- CSRF-подобная защита через honeypot
- Rate limiting по IP
- Серверная валидация всех данных
- Санитизация входных данных

### 14.3 Защита данных
- Пароли не отправляются клиенту
- Секретные ключи хранятся в ENV
- HTTPS обязателен

---

## 15. Переменные окружения

| Переменная | Описание |
|------------|----------|
| DATABASE_URL | Строка подключения к PostgreSQL |
| SESSION_SECRET | Секрет для подписи JWT |

---

## 16. Типы сайтов для аудита

| Значение | Название |
|----------|----------|
| landing | Лендинг |
| business_card | Сайт-визитка |
| corporate | Корпоративный сайт |
| ecommerce | Интернет-магазин |
| medical | Медицинский сайт |
| children | Детские услуги |
| forum | Форум/соц.сеть |
| portal | Корпоративный портал |
| other | Другой формат |

---

## 17. Требования к развертыванию

### 17.1 Серверные требования
- Node.js 18+
- PostgreSQL 14+
- 512 MB RAM минимум
- HTTPS сертификат

### 17.2 Команды
```bash
npm install          # Установка зависимостей
npm run db:push      # Синхронизация БД
npm run dev          # Запуск dev-сервера
npm run build        # Сборка production
npm start            # Запуск production
```

### 17.3 Порты
- Frontend + Backend: 5000 (единый сервер)

---

## 18. Чек-лист функций

### Публичная часть
- [ ] Главная страница с формой проверки
- [ ] Результаты аудита (9 критериев)
- [ ] Страница пакетов услуг
- [ ] Страница кейсов
- [ ] FAQ (аккордеон)
- [ ] Форма обратной связи
- [ ] Авторизация (email + OAuth)
- [ ] Страницы документов
- [ ] Темная тема
- [ ] Адаптивный дизайн

### Личный кабинет
- [ ] Просмотр заказов
- [ ] Редактирование профиля
- [ ] Реферальная программа
- [ ] Запрос выплаты
- [ ] Уведомления
- [ ] Настройки подписок

### Админ-панель
- [ ] Статистика и дашборд
- [ ] Управление пользователями
- [ ] Управление пакетами
- [ ] Управление промокодами
- [ ] Управление рефералами
- [ ] Управление кейсами
- [ ] Управление FAQ
- [ ] Просмотр сообщений
- [ ] Настройки сайта
- [ ] Редактор документов
- [ ] Просмотр платежей
- [ ] Настройки OAuth

### Интеграции
- [ ] YooKassa платежи
- [ ] VK OAuth
- [ ] Яндекс OAuth

---

*Версия: 1.0*
*Дата: Декабрь 2025*
