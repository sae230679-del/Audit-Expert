# SocPlanPro - Память проекта

## Последнее обновление: 02.02.2026 (Сессия 3)

---

## Новые функции (02.02.2026 - Сессия 3)

### 1. Настраиваемые источники данных конкурентов

**Коммиты:** `d4385847`, `37106df4`, `ba6250b6`

**Новая таблица: `competitor_source_settings`**
```sql
id VARCHAR(36) PRIMARY KEY
source_key VARCHAR(50) UNIQUE NOT NULL
name TEXT NOT NULL
description TEXT
source_type ENUM('api', 'parser', 'ai')
is_enabled BOOLEAN DEFAULT true
is_paid BOOLEAN DEFAULT false
priority INTEGER DEFAULT 0
config JSONB
last_tested_at TIMESTAMP
last_test_status TEXT
test_message TEXT
created_at TIMESTAMP
updated_at TIMESTAMP
```

**Источники данных (6 типов):**
| Ключ | Тип | Платный | По умолчанию |
|------|-----|---------|--------------|
| yandex_api | API | Да | Выключен |
| twogis_api | API | Да | Выключен |
| yandex_parser | Parser | Нет | Включен |
| twogis_parser | Parser | Нет | Включен |
| website_parser | Parser | Нет | Включен |
| ai_analysis | AI | Зависит | Включен |

**Файлы:**
- `shared/schema.ts` - таблица и enum `competitor_source_type`
- `server/storage.ts` - CRUD методы для источников
- `server/routes.ts` - API endpoints для админки
- `server/parser-service.ts` - новый сервис парсинга (330+ строк)
- `server/directory-service.ts` - интеграция с парсерами
- `client/src/pages/admin/AdminCompetitorSettings.tsx` - админ-панель

**API endpoints:**
```
GET  /api/admin/competitor-source-settings      - Все источники
GET  /api/admin/competitor-source-settings/:id  - Один источник
PUT  /api/admin/competitor-source-settings/:id  - Обновление
```

**Storage методы:**
```typescript
getCompetitorSourceSettings()           // Все настройки
getCompetitorSourceSettingByKey(key)    // По ключу
updateCompetitorSourceSetting(id, data) // Обновление
getEnabledCompetitorSources()           // Только включенные
initializeCompetitorSourceSettings()    // Инициализация БД
```

---

### 2. Бесплатные парсеры для MVP

**Файл: `server/parser-service.ts`**

**Парсер Яндекс.Карт:**
- HTTP запросы к публичному API
- Извлечение: название, адрес, категории, телефон, сайт
- Fallback на поисковую выдачу при ошибке API
- Требует координаты для работы

**Парсер 2ГИС:**
- Парсинг страницы поиска
- Извлечение JSON из script-тегов (`__INITIAL_STATE__`)
- Fallback на regex-паттерны
- Автоматический slug города (москва → moscow)

**Парсер сайтов конкурентов:**
- Извлечение цен (₽, руб, р, RUB)
- Извлечение телефонов (+7/8 формат)
- Извлечение email
- Извлечение услуг по ключевым словам
- **SSRF защита:** блокировка localhost, приватных IP, внутренних диапазонов

**Методы ParserService:**
```typescript
parseYandexMaps(params)     // Парсинг Яндекс.Карт
parse2Gis(params)           // Парсинг 2ГИС
parseWebsite(url)           // Парсинг сайта конкурента
searchCompetitors(...)      // Объединённый поиск
isValidUrl(url)             // Валидация URL (SSRF защита)
getCitySlug(location)       // Slug города для 2ГИС
```

---

### 3. Fallback координаты для городов РФ

**Файл: `server/directory-service.ts`**

**Метод:** `getDefaultCoordinates(location)`

**30+ городов с координатами:**
- Москва, Санкт-Петербург, Уфа, Казань, Новосибирск
- Екатеринбург, Нижний Новгород, Самара, Ростов-на-Дону
- Краснодар, Воронеж, Пермь, Красноярск, Челябинск
- Омск, Волгоград, Саратов, Тюмень, Тольятти
- Ижевск, Барнаул, Ульяновск, Иркутск, Хабаровск
- Ярославль, Владивосток, Махачкала, Томск, Оренбург, Кемерово

**Логика:**
1. Если API геокодирования включен → используем API
2. Иначе → ищем город в fallback-словаре
3. Если не найден → возвращаем Москву по умолчанию

---

### 4. Обновлённая логика DirectoryService

**Изменения в `searchCompetitors()`:**
- Проверка включенных источников из БД
- Автоматический выбор: API или Parser
- Новое поле в ответе: `usedParsers: boolean`
- Геокодирование только при включенном API Яндекса

**Поток данных:**
```
1. Получить enabledSources из БД
2. Проверить: yandex_api включен?
   - Да → использовать Yandex API
   - Нет → проверить yandex_parser
     - Да → использовать парсер
     - Нет → пропустить
3. Аналогично для 2GIS
4. Объединить результаты, удалить дубликаты
5. Вернуть с флагом usedParsers
```

---

### 5. SSRF защита в parseWebsite

**Метод:** `isValidUrl(url)`

**Блокируемые адреса:**
- `localhost`, `127.0.0.0/8`
- `10.0.0.0/8` (приватная сеть)
- `172.16.0.0/12` (приватная сеть)
- `192.168.0.0/16` (приватная сеть)
- `0.0.0.0/8` (текущая сеть)
- `169.254.0.0/16` (link-local)
- `::1`, `fc00::/7`, `fe80::/10` (IPv6)

**Разрешённые протоколы:** только `http:` и `https:`

---

## Обновление БД: 37 таблиц

**Новая таблица:**
- `competitor_source_settings` - настройки источников данных

**Новый enum:**
- `competitor_source_type` - 'api', 'parser', 'ai'

---

## Новые функции (02.02.2026 - Сессия 2)

### 1. Экспорт бизнес-планов (PDF/Word/Excel)

**Коммиты:** `9d06689`, `5f5c3be`, `bd54bab`

**Файлы:**
- `server/export-service.ts` - новый сервис генерации документов
- `server/routes.ts` - API endpoint `/api/business-plans/:id/export/:format`
- `client/src/pages/dashboard/PlanView.tsx` - кнопки экспорта

**Функционал:**
- **PDF**: Генерация документа со всеми 15 разделами бизнес-плана
- **Word (.docx)**: Форматированный документ с заголовками и метаданными
- **Excel (.xlsx)**: 4 листа - Сводка, Финансовый план, Смета расходов, Движение денежных средств
- Проверка прав доступа (только владелец может экспортировать свой план)
- Меню "Скачать" с индикаторами загрузки

**Зависимости:** `pdfkit`, `docx`, `exceljs`

---

### 2. Система шаблонов бизнес-планов

**Коммиты:** `668dc27`, `5db0ca1`, `1f75cbb`

**Файлы:**
- `shared/schema.ts` - таблица `plan_templates`
- `server/storage.ts` - CRUD операции для шаблонов
- `server/routes.ts` - API endpoints
- `client/src/pages/admin/AdminPlanTemplates.tsx` - страница админки
- `client/src/components/layout/AdminLayout.tsx` - ссылка в навигации
- `client/src/App.tsx` - маршрут `/admin/plan-templates`

**API endpoints:**
```
GET  /api/plan-templates              - Публичные шаблоны
GET  /api/plan-templates/:id          - Получение шаблона
POST /api/plan-templates/:id/use      - Использование шаблона
GET  /api/admin/plan-templates        - Все шаблоны (админ)
POST /api/admin/plan-templates        - Создание (админ)
PATCH /api/admin/plan-templates/:id   - Обновление (админ)
DELETE /api/admin/plan-templates/:id  - Удаление (админ)
```

**Структура таблицы `plan_templates`:**
```sql
id VARCHAR(36) PRIMARY KEY
name TEXT NOT NULL
description TEXT
sphere_id VARCHAR(36)
sphere_name TEXT
preview_image TEXT
wizard_data JSONB
is_public BOOLEAN DEFAULT false
is_system_template BOOLEAN DEFAULT false
created_by VARCHAR(36)
usage_count INTEGER DEFAULT 0
sort_order INTEGER DEFAULT 0
created_at TIMESTAMP
updated_at TIMESTAMP
```

---

### 3. Обновление структуры бизнес-плана (15 разделов)

**Коммит:** `b099b3a`

**Полная структура 15 разделов:**
1. Резюме проекта
2. Описание бизнеса
3. Анализ рынка
4. Маркетинговый план
5. Организационный план
6. Производственный план
7. Финансовый план
8. Оценка рисков
9. Правовые аспекты
10. Анализ конкурентов
11. **SWOT-анализ** (NEW)
12. План развития
13. **Дополнительные источники дохода** (NEW)
14. Социальная значимость
15. Приложения

---

### 4. Автосохранение и предпросмотр мастера

**Коммиты:** `c1fcb27`, `52aca68`

**Функционал:**
- Автосохранение с debounce 2 секунды
- Таблица `wizard_drafts` для хранения
- Восстановление через URL параметр `?draft=id`
- Предпросмотр плана со структурой 15 разделов

---

## Администрирование

### SQL для назначения админа в production:
```sql
UPDATE user_roles SET role = 'admin' WHERE user_id = '1';
-- Пользователь: sae230679@yandex.ru (id=1)
```

### Инициализация источников конкурентов:
```sql
-- Автоматически при первом запуске через initializeCompetitorSourceSettings()
```

---

## Новые функции (02.02.2026 - Сессия 1)

### 1. Модуль консультаций с юристами

| Компонент | Описание |
|-----------|----------|
| **AI-консультант** | Бесплатные мгновенные ответы с интеграцией справочника и веб-поиска |
| **Юрист-консультации** | Отправка вопросов юристам с отслеживанием статуса |
| **Админ-панель юристов** | Панель для юристов с обработкой заявок |

#### API Endpoints (8 новых)
```
# Для пользователей (authMiddleware)
GET  /api/consultations           - Мои консультации
GET  /api/consultations/:id       - Консультация по ID
POST /api/consultations           - Создать консультацию
POST /api/consultations/:id/close - Закрыть консультацию

# Для юристов (authMiddleware + lawyerMiddleware)
GET  /api/lawyer/consultations           - Все консультации
GET  /api/lawyer/my-consultations        - Мои назначенные
POST /api/lawyer/consultations/:id/assign - Взять в работу
POST /api/lawyer/consultations/:id/answer - Дать ответ
```

---

## Новые функции (01.02.2026)

### 1. Анализ конкурентов - AI SWOT
| Функция | Описание |
|---------|----------|
| AI SWOT-анализ | Сильные/слабые стороны, возможности, угрозы |
| Индекс конкурентоспособности | 0-100 баллов с визуализацией |
| Рыночное позиционирование | Анализ позиции на рынке |
| Барьеры входа | Выявление входных барьеров |
| Факторы успеха | Ключевые критерии успеха |

### 2. Управление справочниками (админка)
| Функция | Описание |
|---------|----------|
| Режим Яндекс | Только Яндекс.Карты (по умолчанию) |
| Режим Яндекс + 2ГИС | Пользователь выбирает источник |
| API ключи | Отдельное управление ключами |

### 3. Интерактивная карта конкурентов
| Функция | Описание |
|---------|----------|
| Leaflet 4.x | React 18 совместимая карта |
| Маркеры | Отображение всех конкурентов |
| Popup | Название, адрес, рейтинг, источник |
| Автоцентрирование | По средним координатам |
| 3 режима | Список / Таблица / Карта |

---

## База данных: 37 таблиц

| Таблица | Колонок | Описание |
|---------|---------|----------|
| users | 5 | Пользователи (id serial) |
| profiles | 18 | Профили пользователей |
| user_roles | 4 | Роли (user/manager/lawyer/admin) |
| business_plans | 20 | Бизнес-планы |
| plan_variants | 10 | Варианты планов (best_of_three) |
| plan_templates | 14 | Шаблоны планов |
| wizard_drafts | 6 | Черновики мастера |
| business_spheres | 7 | Сферы бизнеса |
| subscriptions | 18 | Подписки |
| orders | 12 | Заказы |
| payments | 12 | Платежи |
| consultations | 12 | Консультации |
| promo_codes | 11 | Промокоды |
| referrals | 13 | Рефералы |
| ai_settings | 13 | Настройки AI провайдеров |
| search_settings | 9 | Настройки Yandex Search |
| payment_settings | 11 | Настройки YooKassa |
| directory_settings | 12 | Настройки справочников |
| competitor_source_settings | 13 | **NEW** Источники данных конкурентов |
| consultant_settings | 11 | Настройки AI-консультанта |
| consultant_chats | 5 | Чаты консультанта |
| consultant_messages | 7 | Сообщения консультанта |
| handbook_categories | 9 | Категории справочника |
| handbook_articles | 12 | Статьи справочника |
| regions | 11 | Регионы РФ (85 субъектов) |
| eligibility_checks | 14 | Проверки права на соцконтракт |
| defense_sessions | 10 | Сессии подготовки к защите |
| defense_questions | 7 | Вопросы защиты |
| defense_answers | 9 | Ответы на защите |
| defense_checklist | 12 | Чек-лист готовности |
| defense_tests | 9 | Тесты защиты |
| social_contract_questions | 10 | База вопросов теста |
| social_contract_test_sessions | 12 | Сессии тестирования |
| social_contract_test_answers | 8 | Ответы на тест |
| social_contract_user_stats | 13 | Статистика пользователей |
| competitor_analyses | 10 | Анализ конкурентов |
| uploaded_documents | 8 | Загруженные документы |

---

## Файловая структура

### Backend (server/)
```
server/
├── index.ts              # Точка входа
├── routes.ts             # API маршруты (2400+ строк)
├── storage.ts            # Работа с БД (1200+ строк, 70+ методов)
├── auth.ts               # JWT аутентификация
├── db.ts                 # Подключение PostgreSQL
├── vite.ts               # Интеграция Vite
├── ai-service.ts         # AI провайдеры (OpenAI, GigaChat, YandexGPT)
├── gigachat-client.ts    # Нативный клиент GigaChat
├── payment-service.ts    # YooKassa интеграция
├── consultant-service.ts # AI-консультант
├── defense-service.ts    # Подготовка к защите
├── directory-service.ts  # Справочники (Яндекс, 2ГИС) + fallback координаты
├── parser-service.ts     # **NEW** Парсеры (Яндекс, 2ГИС, сайты)
├── export-service.ts     # Экспорт (PDF, Word, Excel)
├── yandex-search.ts      # Yandex Search API
├── regions-data.ts       # Регионы РФ с ПМ 2026
└── social-contract-questions.ts # База вопросов (90+)
```

### Админ-панель (11 страниц)
```
client/src/pages/admin/
├── AdminDashboard.tsx
├── AdminUsers.tsx
├── AdminOrders.tsx
├── AdminPlans.tsx
├── AdminPayments.tsx
├── AdminAIPrompts.tsx
├── AdminPlanTemplates.tsx
├── AdminDirectorySettings.tsx
├── AdminCompetitorSettings.tsx   # **NEW**
├── AdminHandbook.tsx
└── LawyerConsultations.tsx
```

---

## Продакшен

- **Деплой**: autoscale (Replit)
- **Build**: `npm run build` (vite + esbuild)
- **Run**: `npm run start` (node dist/index.js)
- **Статус**: Обновлено 02.02.2026

---

## Технические заметки

### users.id = INTEGER
Всегда использовать `String(user.id)` перед string-методами (slice, substring и т.д.)

### req.params = string | string[]
Всегда использовать `String(req.params.id)` для типобезопасности

### GigaChat API
```typescript
// Правильный вызов
const response = await client.chat(
  [{ role: "user", content: "..." }],
  { temperature: 0.7 }
);
const text = response.choices[0]?.message?.content;
```

### API ответы = camelCase
- `orderNumber` не `order_number`
- `paymentMethod` не `payment_method`
- `startsAt` не `starts_at`

### SSRF защита
При парсинге внешних сайтов всегда проверять URL через `isValidUrl()` перед fetch.

---

## Решения типичных ошибок (Troubleshooting)

### 1. LSP ошибки типизации

| Ошибка | Причина | Решение |
|--------|---------|---------|
| `user.id.slice is not a function` | `users.id` = integer, не string | `String(user.id).slice(0, 8)` |
| `req.params.id` type error | `req.params` = `string \| string[]` | `String(req.params.id)` |
| `messages` not in `GigaChatMessage[]` | Неправильный вызов chat() | Вызывать `client.chat([...], options)`, не объектом |
| `content` not on `GigaChatResponse` | Неправильный путь к ответу | `response.choices[0]?.message?.content` |

**Правило:** Всегда использовать `String()` для user.id и req.params.id

---

### 2. Ошибки роутинга (React Router DOM)

| Ошибка | Причина | Решение |
|--------|---------|---------|
| Страница не отображается | Маршрут не добавлен в App.tsx | Добавить `<Route path="/..." element={<Component />} />` |
| Защищённый маршрут не работает | Отсутствует ProtectedRoute wrapper | Обернуть в `<ProtectedRoute><Component /></ProtectedRoute>` |
| Админ-страница доступна всем | Нет проверки роли | Добавить `allowedRoles={['admin']}` в ProtectedRoute |

**Проект использует react-router-dom, НЕ wouter!**

---

### 3. Ошибки публикации (Deployment)

| Ошибка | Причина | Решение |
|--------|---------|---------|
| "Failed to fetch" при валидации миграций | Временная сетевая ошибка Replit | Cancel → Republish |
| "Failed to validate database migrations" | Схема не синхронизирована | `npm run db:push` перед публикацией |
| "No changes detected" но ошибка | Кэш валидации | `npm run db:push --force`, затем Republish |

**Алгоритм при ошибке публикации:**
1. Выполнить `npm run db:push`
2. Если "No changes detected" — схема уже синхронизирована
3. Нажать Cancel, затем Republish
4. Если повторяется — `npm run db:push --force`

---

### 4. Ошибки геокодирования

| Ошибка | Причина | Решение |
|--------|---------|---------|
| Платный API вызывается при выключенном источнике | Нет проверки isEnabled | Проверять `yandexApiEnabled` перед вызовом API |
| Координаты не найдены | Город не в fallback-словаре | Добавить город в `getDefaultCoordinates()` |
| API возвращает ошибку | Нет ключа или лимит | Использовать fallback-координаты |

**Решение:** Добавлена проверка `yandexApiEnabled` перед вызовом geocodeLocation()

---

### 5. Уязвимости безопасности

| Уязвимость | Риск | Решение |
|------------|------|---------|
| SSRF в parseWebsite | Доступ к внутренней сети | Блокировка localhost, 10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16 |
| Небезопасные протоколы | file://, ftp:// | Разрешить только http:// и https:// |
| IPv6 локальные адреса | ::1, fc00::/7, fe80::/10 | Добавить в чёрный список |

**Реализация:** Метод `isValidUrl()` в `parser-service.ts`

---

### 6. Ошибки парсеров

| Ошибка | Причина | Решение |
|--------|---------|---------|
| Яндекс парсер не находит данные | Изменился формат ответа | Fallback на regex-паттерны |
| 2ГИС парсер пустой | `__INITIAL_STATE__` не найден | Fallback на regex из HTML |
| Website parser ошибка | Таймаут или блокировка | try/catch с пустым результатом |

**Архитектура парсеров:** Основной метод → Fallback → Пустой результат

---

### 7. Ошибки базы данных

| Ошибка | Причина | Решение |
|--------|---------|---------|
| Новая таблица не создаётся | Схема не синхронизирована | `npm run db:push` |
| Enum не существует | PostgreSQL enum не создан | Drizzle создаст автоматически при push |
| Миграция падает | Изменение типа PK | **НИКОГДА не менять тип PK!** |

**Правило:** Использовать `npm run db:push`, НЕ ручные миграции

---

### 8. Ошибки AdminLayout

| Ошибка | Причина | Решение |
|--------|---------|---------|
| Новая страница не в меню | Не добавлена ссылка | Добавить в `AdminLayout.tsx` в menuItems |
| 404 на админ-странице | Маршрут не зарегистрирован | Добавить в `App.tsx` с ProtectedRoute |

**Чек-лист новой админ-страницы:**
1. Создать файл `client/src/pages/admin/AdminXxx.tsx`
2. Добавить маршрут в `App.tsx`
3. Добавить ссылку в `AdminLayout.tsx`

---

### 9. Ошибки при работе с AI

| Ошибка | Причина | Решение |
|--------|---------|---------|
| GigaChat 401 | Истёк токен | Refresh через getAccessToken() |
| OpenAI timeout | Большой запрос | Уменьшить контекст или увеличить timeout |
| YandexGPT ошибка | Неверный folder_id | Проверить YANDEX_FOLDER_ID |

---

## Быстрые команды

```bash
# Синхронизация схемы БД
npm run db:push

# Принудительная синхронизация
npm run db:push --force

# Сборка для продакшена
npm run build

# Запуск продакшена
npm run start

# Разработка
npm run dev
```

---

## Контакты и ресурсы

- **Домен**: https://socplan.pro
- **Replit URL**: https://socbplan-1.replit.app
- **Админ email**: sae230679@yandex.ru (id=1)
