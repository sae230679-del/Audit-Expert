# SocPlanPro - Память проекта

## Последнее обновление: 01.02.2026

---

## Полный аудит проекта

### База данных: 33 таблицы
Все таблицы имеют первичные ключи (PK).

| Таблица | Колонок | Описание |
|---------|---------|----------|
| users | 5 | Пользователи (id serial) |
| profiles | 18 | Профили пользователей |
| user_roles | 4 | Роли (user/manager/lawyer/admin) |
| business_plans | 20 | Бизнес-планы |
| plan_variants | 10 | Варианты планов (best_of_three) |
| business_spheres | 7 | Сферы бизнеса |
| subscriptions | 18 | Подписки |
| orders | 12 | Заказы |
| payments | 12 | Платежи |
| consultations | 12 | Консультации |
| promo_codes | 11 | Промокоды |
| referrals | 13 | Рефералы |
| ai_settings | 13 | Настройки AI провайдеров |
| search_settings | 9 | Настройки Yandex Search |
| payment_settings | 11 | Настройки YooKassa |
| consultant_settings | 11 | Настройки AI-консультанта |
| consultant_chats | 5 | Чаты консультанта |
| consultant_messages | 7 | Сообщения консультанта |
| handbook_categories | 9 | Категории справочника |
| handbook_articles | 12 | Статьи справочника |
| regions | 11 | Регионы РФ (85 субъектов) |
| eligibility_checks | 14 | Проверки права на соцконтракт |
| defense_sessions | 10 | Сессии подготовки к защите |
| defense_questions | 7 | Вопросы защиты |
| defense_answers | 9 | Ответы на защите |
| defense_checklist | 12 | Чек-лист готовности |
| defense_tests | 9 | Тесты защиты |
| social_contract_questions | 10 | База вопросов теста |
| social_contract_test_sessions | 12 | Сессии тестирования |
| social_contract_test_answers | 8 | Ответы на тест |
| social_contract_user_stats | 13 | Статистика пользователей |
| competitor_analyses | 10 | Анализ конкурентов |
| uploaded_documents | 8 | Загруженные документы |

---

## Исправленные ошибки (01.02.2026)

### 1. LSP ошибки в routes.ts (7 шт.)

| Строка | Ошибка | Исправление |
|--------|--------|-------------|
| 2007-2015 | `messages` not in `GigaChatMessage[]` | Вызов `chat()` с массивом, не объектом |
| 2015 | `content` not on `GigaChatResponse` | `response.choices[0]?.message?.content` |
| 2102 | `string \| string[]` to `string` | `String(userId)` |
| 2138 | `req.params.id` type | `String(req.params.id)` |
| 2174 | `req.params.id` type | `String(req.params.id)` |
| 2208 | `req.params.id` type | `String(req.params.id)` |
| 2220 | `req.params.id` type | `String(req.params.id)` |

### 2. Удаление Supabase зависимостей

| Файл | Статус |
|------|--------|
| `client/src/integrations/supabase/client.ts` | Удалён |
| `client/src/integrations/supabase/types.ts` | Удалён |
| `client/src/integrations/` папка | Удалена (пустая) |

### 3. Критические ошибки миграции (ранее)

| Ошибка | Причина | Решение |
|--------|---------|---------|
| `user.id.slice is not a function` | `users.id` = integer, не string | `String(user.id).slice(0, 8)` |
| Supabase вызовы на фронте | Legacy код из Lovable | Замена на fetch + Bearer token |
| camelCase vs snake_case | API ответы | Унификация на camelCase |

---

## API Endpoints (70+ роутов)

### Публичные
- `GET /api/health` - Проверка статуса
- `GET /api/regions` - Регионы РФ (85)
- `GET /api/regions/:id` - Регион по ID
- `POST /api/eligibility/check` - Расчёт права на соцконтракт
- `GET /api/social-contract-test/info` - Информация о тесте
- `GET /api/social-contract-test/questions` - Случайные вопросы

### Аутентификация
- `POST /api/auth/register` - Регистрация
- `POST /api/auth/login` - Вход
- `GET /api/auth/me` - Текущий пользователь

### Пользователь (authMiddleware)
- `GET /api/profile` - Профиль
- `PUT /api/profile` - Обновление профиля
- `GET /api/user/dashboard` - Дашборд
- `GET /api/business-plans` - Мои планы
- `POST /api/business-plans/generate` - Генерация плана
- `GET /api/payments/:id/status` - Статус платежа
- `POST /api/payments/create` - Создание платежа
- `GET /api/consultant/chats` - Чаты консультанта
- `POST /api/consultant/chats/:id/ask` - Вопрос консультанту
- `GET /api/defense/sessions` - Сессии защиты
- `POST /api/social-contract-test/start` - Начать тест
- `POST /api/social-contract-test/hint` - AI подсказка

### Админ (authMiddleware + adminMiddleware)
- `GET /api/admin/stats` - Статистика
- `GET /api/admin/users` - Пользователи
- `PUT /api/admin/users/:userId/role` - Изменить роль
- `GET /api/admin/plans` - Все планы
- `GET /api/admin/orders` - Все заказы
- `PUT /api/admin/orders/:id` - Обновить заказ
- `GET /api/admin/payments` - Все платежи
- `GET /api/admin/consultations` - Все консультации
- `PUT /api/admin/consultations/:id` - Обновить консультацию
- `GET /api/admin/promo-codes` - Промокоды
- `POST /api/admin/promo-codes` - Создать промокод
- `PUT /api/admin/promo-codes/:id` - Обновить промокод
- `DELETE /api/admin/promo-codes/:id` - Удалить промокод
- `GET /api/admin/ai-settings` - Настройки AI
- `POST /api/admin/ai-settings/:id/test` - Тест AI
- `GET /api/admin/search-settings` - Настройки поиска
- `GET /api/admin/payment-settings` - Настройки YooKassa
- `GET /api/admin/handbook-*` - Справочник

### Webhooks
- `POST /api/webhooks/yookassa` - YooKassa уведомления

---

## Файловая структура

### Backend (server/)
```
server/
├── index.ts            # Точка входа
├── routes.ts           # API маршруты (2231 строка)
├── storage.ts          # Работа с БД (1086 строк, 60+ методов)
├── auth.ts             # JWT аутентификация
├── db.ts               # Подключение PostgreSQL
├── vite.ts             # Интеграция Vite
├── ai-service.ts       # AI провайдеры (OpenAI, GigaChat, YandexGPT)
├── gigachat-client.ts  # Нативный клиент GigaChat
├── payment-service.ts  # YooKassa интеграция
├── consultant-service.ts # AI-консультант
├── defense-service.ts  # Подготовка к защите
├── yandex-search.ts    # Yandex Search API
├── regions-data.ts     # Регионы РФ с ПМ 2026
└── social-contract-questions.ts # База вопросов (90+)
```

### Frontend (client/src/)
```
client/src/
├── pages/
│   ├── admin/          # 10 страниц админки
│   ├── dashboard/      # 10 страниц ЛК
│   ├── Login.tsx
│   ├── Register.tsx
│   ├── Index.tsx
│   ├── SocialContractTest.tsx
│   ├── EligibilityCalculator.tsx
│   └── Consultant.tsx
├── components/         # UI компоненты
├── hooks/
│   ├── useAuth.tsx
│   └── useUserRole.tsx
└── lib/
    └── queryClient.ts
```

### Shared
```
shared/
└── schema.ts           # Drizzle схема (685 строк, 33 таблицы)
```

---

## Интеграции

### AI Провайдеры
| Провайдер | Статус | Файл |
|-----------|--------|------|
| OpenAI | ✅ Готов | ai-service.ts |
| GigaChat | ✅ Готов | gigachat-client.ts |
| YandexGPT | ✅ Готов | ai-service.ts |

### Платежи
| Сервис | Статус | Файл |
|--------|--------|------|
| YooKassa | ✅ Готов | payment-service.ts |

### Поиск
| Сервис | Статус | Файл |
|--------|--------|------|
| Yandex Search | ✅ Готов | yandex-search.ts |

---

## Чек-лист готовности

### Код
- [x] Все LSP ошибки исправлены (7/7)
- [x] Supabase полностью удалён
- [x] 33 таблицы с PK в БД
- [x] 70+ API endpoints
- [x] 60+ методов в storage.ts
- [x] JWT аутентификация работает

### Тестирование
- [x] /api/health - OK
- [x] /api/regions - 85 регионов
- [x] /api/social-contract-test/info - OK
- [ ] Админ-панель (требует логин)
- [ ] ЛК пользователя (требует логин)
- [ ] Реферальная программа (требует логин)
- [ ] AI ключи (требует настройку)

---

## Следующие шаги

### Приоритет 1: Тестирование
1. Тестирование админ-панели с реальным аккаунтом
2. Тестирование ЛК пользователя
3. Тестирование реферальной программы
4. Тестирование AI ключей (OpenAI, GigaChat, YandexGPT)

### Приоритет 2: Улучшения
1. Экспорт бизнес-плана в PDF/DOCX
2. Email уведомления
3. Расширение базы вопросов до 200+

---

## Технические заметки

### users.id = INTEGER
Всегда использовать `String(user.id)` перед string-методами (slice, substring и т.д.)

### req.params = string | string[]
Всегда использовать `String(req.params.id)` для типобезопасности

### GigaChat API
```typescript
// Правильный вызов
const response = await client.chat(
  [{ role: "user", content: "..." }],
  { temperature: 0.7 }
);
const text = response.choices[0]?.message?.content;
```

### API ответы = camelCase
- `orderNumber` не `order_number`
- `paymentMethod` не `payment_method`
- `startsAt` не `starts_at`
