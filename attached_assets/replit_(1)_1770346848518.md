# SocPlanPro - Платформа генерации бизнес-планов

## Overview
SocPlanPro is a web platform designed for the automated generation of business plans using artificial intelligence. It targets individuals, self-employed persons, and individual entrepreneurs within the Russian Federation, aiming to simplify the process of creating business plans and facilitating access to social contracts. The platform provides tools for eligibility checks, AI-powered plan generation, and preparation for official social contract testing, contributing to economic empowerment and business development.

## User Preferences
I prefer iterative development with clear, concise communication. Before making major architectural changes or integrating new third-party services, please ask for my approval. Ensure that all explanations are detailed, particularly regarding core functionalities and design decisions. I expect the agent to focus on delivering robust, high-quality code.

## System Architecture

### UI/UX Decisions
The frontend is built with React 18 and TypeScript, utilizing Vite for fast development and optimized builds. Styling is managed with TailwindCSS and shadcn/ui for a modern, responsive, and consistent user interface. React Router DOM handles navigation.

### Technical Implementations
The backend is powered by Node.js with Express 5 and TypeScript, providing a robust API layer. Drizzle ORM is used for database interactions, with PostgreSQL (Neon) as the primary database. The project adopts a full-stack monorepo structure, separating client, server, and shared code.

### Feature Specifications
- **Business Plan Wizard (10-Step)**: New wizard-based generator at `/dashboard/generator/wizard` with:
  - Step 1: Purpose selection (social contract, credit, subsidy, investment, personal)
  - Step 2: Applicant status and data (conditional for social contract)
  - Step 3: Eligibility check integration (conditional for social contract)
  - Step 4: Business sphere selection with subcategories
  - Step 5: Idea description with products/services list
  - Step 6: Financial parameters (investment, revenue, expenses, payback)
  - Step 7: Location (home, rent, mobile, online)
  - Step 8: Competitor analysis integration
  - Step 9: Cost estimate with validation (15% rent, 5% advertising limits)
  - Step 10: Generation preferences (mode, AI provider, tax system)
  - **Draft Autosave**: Automatic saving of wizard progress with 2-second debounce, stored in `wizard_drafts` table. Drafts can be restored via URL parameter `?draft=id`
  - **Plan Preview Modal**: Before generation, shows 15-section structure with summary of entered data (includes SWOT analysis and additional income sources)
- **Business Plan Generation**: AI-driven generation of 15-section business plans (includes SWOT analysis and additional income sources). Supports multiple AI providers and generation modes (single, best_of_three, sequential, dual, all_together).
- **Export to PDF/Word/Excel**: Server-side export of business plans to PDF, DOCX, and XLSX formats via `/api/business-plans/:id/export/:format` endpoint.
- **Plan Templates**: Admin-managed templates at `/admin/plan-templates` with CRUD operations, usage tracking, and public/private visibility. API: `/api/plan-templates` for users, `/api/admin/plan-templates` for admins.
- **Social Contract Eligibility Calculator**: A step-by-step calculator at `/dashboard/social-contract/calculator` for assessing eligibility based on regional living minimums, family composition, and income, adhering to Russian Federation criteria for 2026.
- **Social Contract Testing Module**: Offers training and exam modes for preparing users for the official social contract test, including AI hints during training.
- **AI-Consultant**: Provides AI-powered consultations with web search capabilities.
- **Competitor Analysis Module**: Dual-source competitor search using Yandex.Maps and 2GIS with automatic deduplication, geocoding, market analysis, filtering, sorting and CSV export.
  - **Configurable Data Sources**: Admin panel at `/admin/competitor-settings` for enabling/disabling APIs and parsers
  - **Free Parsers for MVP**: HTTP-based parsers for Yandex Maps and 2GIS (no API keys required)
  - **Website Parser**: Extracts prices, services, and contacts from competitor websites with SSRF protection
  - **Fallback Coordinates**: Default coordinates for 30+ major Russian cities when API geocoding is disabled
  - **Source Types**: API (paid), Parser (free), AI analysis — each can be toggled independently
- **User Roles**: Differentiates between 'user', 'manager', 'lawyer', and 'admin' roles with varying permissions.
- **Authentication**: Custom JWT-based authentication for secure user access.
- **Admin AI Prompts Management**: Admin panel at `/admin/ai-prompts` for managing AI prompts by category and agent role (analyst, financier, editor) with full CRUD operations.
- **Consultations Module**: Dual consultation system at `/dashboard/consultations`:
  - AI Consultant: Free, unlimited instant answers with handbook and web search integration
  - Lawyer Consultations: Paid/free consultations with status tracking (new → in_progress → answered → closed)
  - Lawyer Admin Panel at `/admin/lawyer-consultations` with statistics dashboard, request management, and response functionality
  - Topics: social_contract, business_plan, registration, taxes, documents, other
  - Role-based access via lawyerMiddleware (lawyer/admin roles)

### System Design Choices
- **Database Schema**: Key tables include `users`, `business_plans`, `subscriptions`, `payments`, `regions`, and `eligibility_checks`.
- **AI Service Abstraction**: A unified AI service (`server/ai-service.ts`) allows integration with multiple AI providers (OpenAI, GigaChat, YandexGPT) through a consistent interface.
- **Microservices-like Structure**: Logical separation of concerns into distinct modules (e.g., authentication, AI services, eligibility calculation).
- **Configuration Management**: API keys and sensitive data are managed via environment variables and stored securely within the database for AI provider settings.

## External Dependencies

- **Database**: PostgreSQL (via Neon)
- **ORM**: Drizzle ORM
- **AI Providers**:
    - OpenAI API (models: gpt-4o-mini, gpt-4o, gpt-4-turbo)
    - GigaChat (Sberbank) API (models: GigaChat, GigaChat-Plus, GigaChat-Pro)
    - YandexGPT (Yandex AI Studio) API (models: yandexgpt-lite, yandexgpt)
- **Payment Gateway**: YooKassa
- **Frontend Framework**: React 18
- **Routing**: react-router-dom (НЕ wouter!)
- **Styling**: TailwindCSS, shadcn/ui
- **Build Tool**: Vite

## Важные технические заметки

### Типизация ID
- `users.id` = INTEGER (serial), всегда использовать `String(user.id)`
- `req.params.id` = `string | string[]`, всегда использовать `String(req.params.id)`

### Публикация (Deployment)
При ошибке "Failed to validate database migrations":
1. `npm run db:push`
2. Cancel → Republish

### База данных
- 37 таблиц в PostgreSQL (Neon)
- Синхронизация: `npm run db:push`
- НИКОГДА не менять тип primary key!

### Парсеры конкурентов
- Бесплатные парсеры включены по умолчанию (yandex_parser, twogis_parser, website_parser)
- Платные API выключены (yandex_api, twogis_api)
- SSRF защита: блокировка localhost, приватных IP
- Fallback координаты для 30+ городов РФ