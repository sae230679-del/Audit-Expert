# Help152FZ — Реестр ошибок и изменений

## Статусы
- **КРИТИЧЕСКАЯ** — ломает функциональность, данные теряются или повреждаются
- **ВАЖНАЯ** — функция работает неправильно, но не ломает систему
- **НЕЗНАЧИТЕЛЬНАЯ** — косметические проблемы, неоптимальный код

---

## КРИТИЧЕСКИЕ ОШИБКИ

### BUG-001: Реферальная комиссия — поиск реферера по неправильному полю
- **Файл**: `server/yookassa.ts`, строка 189
- **Описание**: Функция `processReferralCommission` вызывает `storage.getUserByReferralCode(user.referredBy)`, но поле `user.referredBy` хранит **ID пользователя** (UUID), а не его реферальный код. Функция `getUserByReferralCode` ищет по полю `referral_code`, которое содержит 8-символьный HEX-код.
- **Результат**: Комиссия **НИКОГДА** не начисляется через webhook YooKassa.
- **Исправление**: Заменить `getUserByReferralCode(user.referredBy)` на `storage.getUser(user.referredBy)`.
- **Статус**: НЕ ИСПРАВЛЕНО

### BUG-002: Запись реферала (referrals) не создаётся при регистрации
- **Файл**: `server/routes.ts`, строки 1868-1883
- **Описание**: При регистрации по реферальному коду бонус добавляется к балансу реферера, но запись в таблицу `referrals` НЕ создаётся. Это означает, что маршрут `GET /api/user/referrals` всегда возвращает пустой массив.
- **Результат**: Реферер не видит своих приглашённых пользователей в кабинете.
- **Исправление**: Добавить `await storage.createReferral({ referrerId, refereeId, status: 'registered' })` при регистрации.
- **Статус**: НЕ ИСПРАВЛЕНО

---

## ВАЖНЫЕ ОШИБКИ

### BUG-003: Email-сервис — начальная инициализация без настроек
- **Файл**: `server/email-service.ts`, `server/routes.ts` (строка 3370)
- **Описание**: Email-сервис инициализируется при старте сервера. Если SMTP-настройки не заполнены в БД — email остаётся отключённым. При обновлении настроек в админ-панели вызывается `updateEmailTransporter()`, что корректно реинициализирует сервис. Однако начальная инициализация при пустых настройках — ожидаемое поведение.
- **Результат**: Email не работает до первой настройки SMTP в админ-панели. После настройки — работает без перезапуска.
- **Статус**: ПОДТВЕРЖДЕНО (работает по дизайну, но требует документирования для пользователей)

### BUG-004: Тестовый режим оплаты не начисляет реферальную комиссию
- **Файл**: `server/routes.ts`, строки 816-852
- **Описание**: В тестовом режиме (`yookassaTestMode = true`) заказ помечается как оплаченный, но функция `processReferralCommission` вызывается ТОЛЬКО из webhook YooKassa. В тестовом режиме webhook не вызывается.
- **Результат**: В тестовом режиме реферальные комиссии не начисляются.
- **Исправление**: Добавить вызов `processReferralCommission(order.id, finalAmount)` в ветку тестового режима.
- **Статус**: НЕ ИСПРАВЛЕНО

### BUG-005: Робокасса упоминается, но не реализована
- **Файл**: `attached_assets/AUDIT_EXPERT_SETUP_1769909987484.md`
- **Описание**: В документации проекта упоминается Robokassa как альтернативная платежная система, но в коде реализована ТОЛЬКО YooKassa.
- **Результат**: Нет альтернативной платежной системы.
- **Статус**: ИНФОРМАЦИЯ (не баг — фича не реализована)

### BUG-006: Отсутствует привязка заказа к пользователю при оплате
- **Файл**: `server/routes.ts`, строки 795-810
- **Описание**: При создании заказа через `POST /api/payment/create` поле `userId` не устанавливается — оно остаётся `null` даже если пользователь авторизован. Это означает, что:
  - Заказ не привязывается к личному кабинету пользователя
  - Реферальная комиссия не может быть начислена (BUG-001 зависит от `order.userId`)
- **Исправление**: Извлекать JWT-токен из заголовка Authorization и устанавливать `userId` в заказе.
- **Статус**: НЕ ИСПРАВЛЕНО

### BUG-007: Раздельные маршруты логина для admin и user
- **Файл**: `server/routes.ts`, строки 908-940 и 1933-1998
- **Описание**: Существует два раздельных маршрута:
  - `POST /api/auth/login` — только для admin/superadmin (возвращает 403 для user)
  - `POST /api/auth/user-login` — для всех пользователей (включая admin)
- **Фронтенд**: Админ-логин использует `/api/auth/login` (client/src/pages/admin/login.tsx), пользовательский вход — `/api/auth/user-login`.
- **Статус**: РАБОТАЕТ ПО ДИЗАЙНУ (раздельные маршруты — архитектурное решение)

### BUG-008: OAuth-регистрация не создаёт userSubscriptions
- **Файл**: `server/routes.ts`, строки 2094-2111, 2220-2237
- **Описание**: При OAuth-регистрации (VK, Яндекс) НЕ создаётся запись в `userSubscriptions`, в отличие от обычной регистрации (строка 1887). Также не отправляется welcome-уведомление.
- **Результат**: OAuth-пользователи не имеют настроек уведомлений по умолчанию.
- **Статус**: НЕ ИСПРАВЛЕНО

### BUG-009: OAuth state не проверяется при callback
- **Файл**: `server/routes.ts`, строки 2027, 2038
- **Описание**: При OAuth-авторизации генерируется `state` (CSRF-защита), но он НЕ сохраняется в сессии и НЕ проверяется в callback-маршруте.
- **Результат**: Потенциальная CSRF-уязвимость в OAuth-потоке.
- **Статус**: НЕ ИСПРАВЛЕНО

### STUB-001: ИНН-проверка в реестре РКН — заглушка
- **Файл**: `server/routes.ts`, строки 696-715
- **Описание**: Маршрут `POST /api/check-inn` возвращает **случайные данные** (заглушку) вместо реальной проверки в реестре Роскомнадзора. Используется `Math.random()` для генерации номера регистрации и даты.
- **Тип**: Заглушка / нереализованная функция (НЕ баг)
- **Результат**: Пользователи получают имитацию данных. Требуется реальная интеграция с API РКН или пометка «демо-данные» в UI.
- **Статус**: ЗАГЛУШКА — требуется реальная интеграция или UI-индикация

---

## НЕЗНАЧИТЕЛЬНЫЕ ПРОБЛЕМЫ

### MINOR-001: Дублирование логики авторизации
- **Файл**: `server/routes.ts`
- **Описание**: Проверка JWT-токена дублируется в каждом маршруте `/api/user/*` вместо использования middleware. Есть `verifyAdmin` middleware, но нет аналогичного `verifyUser`.
- **Рекомендация**: Создать `verifyUser` middleware для упрощения кода.

### MINOR-002: `as any` в обновлении пользователя
- **Файл**: `server/routes.ts`, строки 1863-1866, 1874-1876
- **Описание**: Используется `as any` при обновлении пользователя, что обходит проверку типов TypeScript.

### MINOR-003: Файл routes.ts слишком большой (3562 строки)
- **Описание**: Все маршруты в одном файле. Рекомендуется разделить на модули (auth-routes, user-routes, admin-routes и т.д.).

### MINOR-004: Emoji в email-шаблонах
- **Файл**: `server/email-service.ts`, строка 28
- **Описание**: Используется HTML-символ щита (&#128737;) в email-шаблоне. Может отображаться некорректно в некоторых email-клиентах.

---

## ИСТОРИЯ ИЗМЕНЕНИЙ

### 2026-02-10
- Создан PROJECT_OVERVIEW.md — обзор основной кодовой базы проекта
- Создан ERRORS_AND_CHANGES.md — реестр ошибок
- Проведён глубокий аудит серверного кода
- Выявлено: 2 критических бага, 6 важных багов, 1 заглушка, 1 by-design, 4 незначительных

---

## ПЛАН ИСПРАВЛЕНИЙ (приоритет)

### Фаза 1 — Критические исправления (ломают основную функциональность)
1. [BUG-001] Исправить поиск реферера в processReferralCommission (getUser вместо getUserByReferralCode)
2. [BUG-002] Добавить создание записи referral при регистрации
3. [BUG-006] Привязка userId к заказам при оплате (извлекать из JWT)
4. [BUG-004] Начисление реферальной комиссии в тестовом режиме

### Фаза 2 — Важные улучшения (безопасность, полнота)
5. [BUG-008] OAuth: создание userSubscriptions + welcome notification
6. [BUG-009] OAuth: сохранение и проверка state для CSRF-защиты

### Фаза 3 — Техдолг и заглушки
7. [MINOR-001] Создание verifyUser middleware
8. [MINOR-003] Разделение routes.ts на модули
9. [STUB-001] Реальная интеграция с реестром РКН (или пометка UI как «демо»)
